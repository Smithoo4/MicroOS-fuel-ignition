# OpenSUSE MicroOS Fuel-Ignition Playground

This project is an exercise in learning and experimenting with openSUSE MicroOS, Ignition, and Combustion. The goal is to create a reproducible, customized MicroOS deployment ideal for exploring rootless Podman as a home server.

## Features

This project automates the creation of a configuration ISO that performs the following:

- Locks the root user and creates one non-root user.
- Sets the user's password and SSH keys.
- Creates the wheel group and adds the user to it.
- Creates the /home subvolume needed for the non-root user.
- Sets the hostname, keymap, and timezone.
- Configures sudo to use the wheel group and user passwords.
- Installs bash-completion, nano, git-core, firewalld, and patterns-microos-cockpit.
- Opens firewall ports for SSH, Cockpit, HTTP, and HTTPS.
- Configures git for the non-root user (.gitconfig).
- Generates an SSH key for the non-root user.
- Enables linger for rootless Podman and the podman-auto-update.timer.
- Sets unprivileged ports to start at 80 (needed for HTTP and HTTPS).

## Project Structure

- `templates/`: Contains the templates for `config.ign.template` and `script.template`.
- `vars.yml.example`: A template for your personal configuration variables.
- `vars.yml.bak`: A backup encrypted configuration.
- `vars.yml`: Your private configuration ((Not tracked by Git)).
- `build.py`: The Python engine that renders templates, and builds the ISO.
- `output/`: The directory where the generated Ignition and Combustion files are stored (Not tracked by Git).
- `ignition.iso`: The final configuration ISO generated by the build script (Not tracked by Git).

## How to Use It

### 1. Prerequisites

Ensure you have the following installed on your host system:

- `python3`, `python3-jinja2`, `python3-pyyaml`
- `mkisofs` (for ISO generation)

### 2. Setup Variables

1. Copy the example variables file:

   ```bash
   cp vars.yml.example vars.yml
   ```
   
2. Edit `vars.yml` with your specific details (SSH keys, username, etc.).

### 3. Build the ISO
Run the automated build script:

```bash
python3 build.py
```

This script will:

1. Render the configuration files into the output/ directory.

2. Generate a fresh ignition.iso.

### 4. Installation
Use the generated `ignition.iso` along with the [Self Installing Container Host ISO](https://download.opensuse.org/tumbleweed/appliances/iso/openSUSE-MicroOS.x86_64-ContainerHost-SelfInstall.iso) to boot a new machine. Both ISOs must be mounted; select the **Self Installing** ISO as the boot device.

## Encrypted Backup With Ansible Vault (Optional)

To safely back up your configuration to a public repository without exposing sensitive data (like passwords or SSH keys), use Ansible Vault to create an encrypted copy. The vars.yml file is ignored by Git to prevent accidental leaks.

### 1. Create a Backup

When you have made changes to your local `vars.yml` and want to back them up to GitHub:

```bash
ansible-vault encrypt_path vars.yml --output vars.vault
```

### 2. Restore from Backup

If you pull this repository onto a new machine and need to recreate your local `vars.yml`:

```bash
ansible-vault decrypt vars.vault --output vars.yml
```

### 3. Handling Legacy Backups

If you have an existing encrypted backup (e.g., vars.yml.bak), you can also track it in Git as a secondary recovery option. To restore from it:

```bash
ansible-vault decrypt vars.yml.bak --output vars.yml
```

## Lessons Learned

### Starting Point

OpenSUSE provides an [Ignition & Combustion Config Generator](https://opensuse.github.io/fuel-ignition/edit) which, along with their documentation on [Ignition](https://en.opensuse.org/Portal:MicroOS/Ignition) and [Combustion](https://en.opensuse.org/Portal:MicroOS/Combustion), served as a great starting point. It covered many of the basics, such as creating new users and setting up their home directories—tasks that, while documented elsewhere, would have taken time to find. The Ignition & Combustion Config Generator also gave good directories on how to generator the ISO to be used in the install. 

### Use the Self-Installing Container Host ISO

To trigger Ignition and Combustion during installation, you must use a specific ISO as the generic MicroOS installer will not work. The correct version is the [Self Installing Container Host](https://download.opensuse.org/tumbleweed/appliances/iso/openSUSE-MicroOS.x86_64-ContainerHost-SelfInstall.iso).

This took longer to discover than I would like to admit, likely because the download options are split across two different pages:

1. [MicroOS Portal Downloads](https://en.opensuse.org/Portal:MicroOS/Downloads)
2. [Get MicroOS (Server)](https://get.opensuse.org/microos/?type=server#download)

I consistently landed on the first page, which does not appear to link to the Self-Installing ISO.

### Sudo Configuration

By default, MicroOS configures `sudo` to require the root password rather than the user's password, and it does not include a `wheel` group. While this is the "SUSE way," I prefer the workflow where the root account is locked and the user authenticates with their own password. This is more in line with what I am familiar with and is the approach for Ubuntu, Fedora, and NixOS.

Implementing this change provided great insight into how Ignition handles system state. To achieve this, the configuration performs the following:

1. Locks the root user.
2. Creates the `wheel` group (a critical step; omitting this causes Ignition to fail).
3. Adds the non-root user to the `wheel` group.
4. Creates `/etc/sudoers.d/wheel` with the following content:

```sudoers
%wheel ALL=(ALL) ALL
Defaults !targetpw
```

### Firewall-cmd Limitations

An issue occurs where `firewall-cmd` commands within the Combustion script fail. This is likely due to the D-Bus service or the `firewalld` daemon not being fully operational during the Combustion execution phase.

To work around this limitation, the script manually writes the `public.xml` zone file to `/etc/firewalld/zones/public.xml` instead of using the CLI. This ensures the required ports are open immediately upon the first boot without relying on a live daemon during the setup process.

### Mounting the Home Directory in Combustion

To ensure the Combustion script can modify a non-root user's home directory, you must include `mount /home || true` at the start of the script. 

If this step is omitted, any changes made to the home directory will disappear upon login. This happens because the `/home` subvolume is not mounted by default when the Combustion script executes. Without the mount command, the script writes changes directly to the root filesystem; these files are then obscured when the actual home subvolume is mounted during the boot process.

### loginctl limitations

- Simply running `loginctl enable-linger <user>` in a first-boot/Combustion script did **not** reliably enable lingering because the systemd user manager isn’t yet initialized at that stage.
- On MicroOS, lingering is controlled by the presence of a file in `/var/lib/systemd/linger/<user>` — Ignition runs *before* logind starts, so placing that file in the Ignition config ensures `Linger=yes` is applied on first boot.  
- Moving the linger file creation into `config.ign` (rather than a post-boot script) is required to guarantee the user’s systemd user services (e.g., rootless Podman timers) run at boot.


